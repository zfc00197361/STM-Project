\hypertarget{main_8cpp_source}{}\subsection{main.\+cpp}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * File:   main.cpp}
00003 \textcolor{comment}{ * Author: Zoltan Fuzesi C00197361, }
00004 \textcolor{comment}{ * IT Carlow, Software Engineering, }
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Supervisor : Joe Kehoe, }
00007 \textcolor{comment}{ *}
00008 \textcolor{comment}{ * C++ Software Transactional Memory, }
00009 \textcolor{comment}{ * }
00010 \textcolor{comment}{ * Created on December 18, 2017, 2:09 PM}
00011 \textcolor{comment}{ * OSTM base class function declarations.}
00012 \textcolor{comment}{ */}
00013 
00014 \textcolor{preprocessor}{#include <cstdlib>}
00015 \textcolor{preprocessor}{#include <iostream>}
00016 \textcolor{preprocessor}{#include <thread>}
00017 \textcolor{preprocessor}{#include "\hyperlink{_t_m_8h}{TM.h}"}
00018 \textcolor{preprocessor}{#include "\hyperlink{_a_i_b_8h}{AIB.h}"}   
00019 \textcolor{preprocessor}{#include "\hyperlink{_b_o_i_8h}{BOI.h}"}    
00020 \textcolor{preprocessor}{#include <mutex>}
00021 \textcolor{preprocessor}{#include <memory>}
00022 \textcolor{preprocessor}{#include <condition\_variable>}
00023 \textcolor{preprocessor}{#include <vector>}
00024 
\hypertarget{main_8cpp_source.tex_l00032}{}\hyperlink{main_8cpp_a83aef8c5b69afef4e38d14c17fe782b3_a83aef8c5b69afef4e38d14c17fe782b3}{00032} \textcolor{keywordtype}{void} \hyperlink{main_8cpp_a83aef8c5b69afef4e38d14c17fe782b3_a83aef8c5b69afef4e38d14c17fe782b3}{\_two\_account\_transfer\_}(std::shared\_ptr<OSTM> \_to\_, std::shared\_ptr<OSTM> \_from\_,
       \hyperlink{class_t_m}{TM}& \_tm, \textcolor{keywordtype}{double} \_amount) \{
00033     \textcolor{comment}{/* @34 Request for transaction object with the transaction manager*/}
00034     std::shared\_ptr<TX> tx = \_tm.\hyperlink{class_t_m_a41cb0226cc4080c931651b13f74a0075_a41cb0226cc4080c931651b13f74a0075}{\_get\_tx}();
00035     \textcolor{comment}{/* @36-37 Register the two OSTM type shared pointer to the library : \_to\_ and \_from\_ */}
00036     tx->\_register(\_to\_);
00037     tx->\_register(\_from\_);
00038     \textcolor{comment}{/*  @39-40 We need to create local pointers to use the temporary pointers in the transaction */}
00039     std::shared\_ptr<BANK> \_TO\_BANK\_, \_FROM\_BANK\_;
00040     std::shared\_ptr<OSTM> \_TO\_OSTM\_, \_FROM\_OSTM\_;
00041     \textcolor{comment}{/* @42 Declare boolean variable to control the transaction with the while loop*/}
00042     \textcolor{keywordtype}{bool} done = \textcolor{keyword}{false};
00043     \textcolor{comment}{/* @44 Use try catch blocks ! If you try to use exidantly any nullpointer to register,save or load in
       the libaray, then the library wil throw a runtime execption*/}
00044     \textcolor{keywordflow}{try} \{
00045         \textcolor{comment}{/* @46 Declare the WHILE loop with the boolean variable */}
00046         \textcolor{keywordflow}{while} (!done) \{
00047             \textcolor{comment}{/* @48-49 Retrieve the copy OSTM type pointers you registered (\_to\_ and \_from\_) from the
       library, and cast it back to BANK type. In this way you can used the BANK virtual methods to access the AIB and
       BOI objects values*/}
00048             \_TO\_BANK\_ = std::dynamic\_pointer\_cast<\hyperlink{class_b_a_n_k}{BANK}> (tx->load(\_to\_));
00049             \_FROM\_BANK\_ = std::dynamic\_pointer\_cast<\hyperlink{class_b_a_n_k}{BANK}> (tx->load(\_from\_));
00050           
00051             \textcolor{comment}{/* @52-53 Makes changes with the local pointers. Remove value from the first object and add to
       the second object ! TRANSFER ! */}
00052             \_TO\_BANK\_->\hyperlink{class_b_a_n_k_ae3e45b407bf8ec7175662442ea24b7c0_ae3e45b407bf8ec7175662442ea24b7c0}{SetBalance}(\_TO\_BANK\_->GetBalance() + \_amount);
00053             \_FROM\_BANK\_->SetBalance(\_FROM\_BANK\_->GetBalance() - \_amount);
00054             \textcolor{comment}{/* @55-56 Cast back the BANK type pointers to OSTM type before try to store the changes with
       the objetcs */}
00055             \_TO\_OSTM\_ = std::dynamic\_pointer\_cast<\hyperlink{class_o_s_t_m}{OSTM}> (\_TO\_BANK\_);
00056             \_FROM\_OSTM\_ = std::dynamic\_pointer\_cast<\hyperlink{class_o_s_t_m}{OSTM}> (\_FROM\_BANK\_);
00057             \textcolor{comment}{/* @58-59 Store changes has made with the local pointers */}
00058             tx->store(\_TO\_OSTM\_);
00059             tx->store(\_FROM\_OSTM\_);
00060             \textcolor{comment}{/* @62 Commit changes with the nested transaction*/}
00061             done = tx->commit();
00062         \}
00063     \textcolor{comment}{/* @64-65 Catch block to catch runtime errors. Print error to console*/}
00064     \} \textcolor{keywordflow}{catch} (std::runtime\_error& e) \{
00065         std::cout << e.what() << std::endl;
00066     \}
00067 \}
00068 
\hypertarget{main_8cpp_source.tex_l00077}{}\hyperlink{main_8cpp_a5675cb594d74aa1bf5e80233370ffd81_a5675cb594d74aa1bf5e80233370ffd81}{00077} \textcolor{keywordtype}{void} \hyperlink{main_8cpp_a5675cb594d74aa1bf5e80233370ffd81_a5675cb594d74aa1bf5e80233370ffd81}{\_nesting\_}(std::shared\_ptr<OSTM> \_to\_, std::shared\_ptr<OSTM> \_from\_, 
      \hyperlink{class_t_m}{TM}& \_tm, \textcolor{keywordtype}{double} \_amount) \{
00078     \textcolor{comment}{/* @79 Request fro transaction object with the transaction manager*/}
00079     std::shared\_ptr<TX> tx = \_tm.\hyperlink{class_t_m_a41cb0226cc4080c931651b13f74a0075_a41cb0226cc4080c931651b13f74a0075}{\_get\_tx}();
00080     \textcolor{comment}{/* @81-82 Register the two OSTM type shared pointer to the library : \_to\_ and \_from\_ */}
00081     tx->\_register(\_to\_);
00082     tx->\_register(\_from\_);
00083     \textcolor{comment}{/*  @84-85 We need to create local pointers to use the temporary pointers in the transaction */}
00084     std::shared\_ptr<BANK> \_TO\_BANK\_, \_FROM\_BANK\_;
00085     std::shared\_ptr<OSTM> \_TO\_OSTM\_, \_FROM\_OSTM\_;
00086     \textcolor{comment}{/* @87 Declare boolean variable to control the transaction with the while loop*/}
00087     \textcolor{keywordtype}{bool} done = \textcolor{keyword}{false};
00088      \textcolor{comment}{/* @89 Use try catch blocks ! If you try to use exidantly any nullpointer to register,save or load in
       the libaray, then the library wil throw a runtime execption*/}
00089     \textcolor{keywordflow}{try} \{
00090         \textcolor{comment}{/* @91 Declare the WHILE loop with the boolean variable */}
00091         \textcolor{keywordflow}{while} (!done) \{
00092             \textcolor{comment}{/* @93-94 Retrieve the copy OSTM type pointers you registered (\_to\_ and \_from\_) from the
       library, and cast it back to BANK type. In this way you can used the BANK virtual methods to access the AIB and
       BOI objects values*/}
00093             \_TO\_BANK\_ = std::dynamic\_pointer\_cast<\hyperlink{class_b_a_n_k}{BANK}> (tx->load(\_to\_));
00094             \_FROM\_BANK\_ = std::dynamic\_pointer\_cast<\hyperlink{class_b_a_n_k}{BANK}> (tx->load(\_from\_));
00095             
00096             \textcolor{comment}{/* @97-98 make changes with the local pointers */}
00097             \_TO\_BANK\_->\hyperlink{class_b_a_n_k_ae3e45b407bf8ec7175662442ea24b7c0_ae3e45b407bf8ec7175662442ea24b7c0}{SetBalance}(\_TO\_BANK\_->GetBalance() + \_amount);
00098             \_FROM\_BANK\_->SetBalance(\_FROM\_BANK\_->GetBalance() - \_amount);
00099             \textcolor{comment}{/* @100-101 Cast back the BANK type pointers to OSTM type before try to store the changes with
       the objetcs */}
00100             \_TO\_OSTM\_ = std::dynamic\_pointer\_cast<\hyperlink{class_o_s_t_m}{OSTM}> (\_TO\_BANK\_);
00101             \_FROM\_OSTM\_ = std::dynamic\_pointer\_cast<\hyperlink{class_o_s_t_m}{OSTM}> (\_FROM\_BANK\_);
00102             \textcolor{comment}{/* @103-104 Store changes has made with the local pointers */}
00103             tx->store(\_TO\_OSTM\_);
00104             tx->store(\_FROM\_OSTM\_);
00105             
00106             \textcolor{comment}{/* @107 Retrieve a Transaction object to used in the NESTED TRANSACTION. Because the same
       thread request the transaction object the transaction manager will return back the same transaction object, and
       increase the nesting associated with the transaction */}
00107             std::shared\_ptr<TX> txTwo = \_tm.\hyperlink{class_t_m_a41cb0226cc4080c931651b13f74a0075_a41cb0226cc4080c931651b13f74a0075}{\_get\_tx}();
00108              \textcolor{comment}{/* @109 Declare boolean variable to control the nested transaction with the while loop*/}
00109             \textcolor{keywordtype}{bool} nestedDone = \textcolor{keyword}{false};
00110             \textcolor{comment}{/* @111 Declare the WHILE loop with the boolean variable */}
00111             \textcolor{keywordflow}{while} (!nestedDone) \{
00112             
00113                 \textcolor{comment}{/* @114-115Retrieve the copy OSTM type pointers you registered (\_to\_ and \_from\_) from the
       library, and cast it back to BANK type. In this way you can used the BANK virtual methods to access the AIB
       and BOI objects values*/}
00114                 \_TO\_BANK\_ = std::dynamic\_pointer\_cast<\hyperlink{class_b_a_n_k}{BANK}> (txTwo->load(\_to\_));
00115                 \_FROM\_BANK\_ = std::dynamic\_pointer\_cast<\hyperlink{class_b_a_n_k}{BANK}> (txTwo->load(\_from\_));
00116                 \textcolor{comment}{/* @117-118 make changes with the local pointers */}
00117                 \_TO\_BANK\_->\hyperlink{class_b_a_n_k_ae3e45b407bf8ec7175662442ea24b7c0_ae3e45b407bf8ec7175662442ea24b7c0}{SetBalance}(\_TO\_BANK\_->GetBalance() + \_amount);
00118                 \_FROM\_BANK\_->SetBalance(\_FROM\_BANK\_->GetBalance() - \_amount);
00119                 \textcolor{comment}{/* @120-121 Cast back the BANK type pointers to OSTM type before try to store the changes
       with the objetcs */}
00120                 \_TO\_OSTM\_ = std::dynamic\_pointer\_cast<\hyperlink{class_o_s_t_m}{OSTM}> (\_TO\_BANK\_);
00121                 \_FROM\_OSTM\_ = std::dynamic\_pointer\_cast<\hyperlink{class_o_s_t_m}{OSTM}> (\_FROM\_BANK\_);
00122                 \textcolor{comment}{/* @123-124 Store changes has made with the local pointers */}
00123                 txTwo->store(\_TO\_OSTM\_);
00124                 txTwo->store(\_FROM\_OSTM\_);
00125                 \textcolor{comment}{/* @126 Call other function that will nesting the transaction to the next level */}
00126                 \hyperlink{main_8cpp_a83aef8c5b69afef4e38d14c17fe782b3_a83aef8c5b69afef4e38d14c17fe782b3}{\_two\_account\_transfer\_}(\_to\_, \_from\_, \_tm, \_amount);
00127                 \textcolor{comment}{/* @128 Commit changes with the nested transaction*/}
00128                 nestedDone = txTwo->commit();
00129             \}
00130             \textcolor{comment}{/* @131 Commit changes with the outer transaction*/}
00131             done = tx->commit();
00132         \}
00133     \textcolor{comment}{/* @134-135 Catch block to catch runtime errors. Print error to console*/}
00134     \} \textcolor{keywordflow}{catch} (std::runtime\_error& e) \{
00135         std::cout << e.what() << std::endl;
00136     \}
00137 \}
00138 
\hypertarget{main_8cpp_source.tex_l00142}{}\hyperlink{main_8cpp_a840291bc02cba5474a4cb46a9b9566fe_a840291bc02cba5474a4cb46a9b9566fe}{00142} \textcolor{keywordtype}{int} \hyperlink{main_8cpp_a840291bc02cba5474a4cb46a9b9566fe_a840291bc02cba5474a4cb46a9b9566fe}{main}(\textcolor{keywordtype}{void}) \{
00143     
00144      \textcolor{comment}{/* @146 Get the Transaction Manager */}
00145      
00146     \hyperlink{class_t_m}{TM}& tm = \hyperlink{class_t_m_a7ce5f35e0dae76df4fe116cf905bbe60_a7ce5f35e0dae76df4fe116cf905bbe60}{TM::Instance}();
00147     
00148      \textcolor{comment}{/* @151-152 Create BANK object OSTM type. All object will get the unique ID generated by default*/}
00149      
00150     std::shared\_ptr<OSTM> aib\_ptr(\textcolor{keyword}{new} \hyperlink{class_a_i_b}{AIB}(100, 500, \textcolor{stringliteral}{"Joe"}, \textcolor{stringliteral}{"Blog"}, \textcolor{stringliteral}{"High street, Kilkenny, Co.Kilkenny"})
      );
00151     std::shared\_ptr<OSTM> boi\_ptr(\textcolor{keyword}{new} \hyperlink{class_b_o_i}{BOI}(200, 500, \textcolor{stringliteral}{"Mark"}, \textcolor{stringliteral}{"darcy"}, \textcolor{stringliteral}{"Main street, CArlow, Co.Carlow"}));
00152 
00153      
00154      \textcolor{comment}{/* @155-156 Display BANK objects before transaction*/}
00155     aib\_ptr->toString();
00156     boi\_ptr->toString();
00157     
00158      
00159      \textcolor{comment}{/* @160 transferAmount in the transaction, control the value in the transaction between objetcs*/}
00160     \textcolor{keywordtype}{int} transferAmount = 1;
00162     \textcolor{keywordtype}{int} threadArraySize = 300;
00163     \textcolor{comment}{/* @164 Create a thread array with the threadArraySize declared before  */}
00164     std::thread thArray[threadArraySize];
00165     \textcolor{comment}{/* @166 Creating the threads with the loop */}
00166     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < threadArraySize; ++i) \{
00167             \textcolor{comment}{/* @168 with the new thread created call the function \_nesting\_*/}
00168             thArray[i] = std::thread(\hyperlink{main_8cpp_a5675cb594d74aa1bf5e80233370ffd81_a5675cb594d74aa1bf5e80233370ffd81}{\_nesting\_}, aib\_ptr, boi\_ptr, std::ref(tm), transferAmount);
00169             \textcolor{comment}{/* @170 with the new thread created call the function \_two\_account\_transfer\_*/}
00170             thArray[i] = std::thread(\hyperlink{main_8cpp_a83aef8c5b69afef4e38d14c17fe782b3_a83aef8c5b69afef4e38d14c17fe782b3}{\_two\_account\_transfer\_}, aib\_ptr, boi\_ptr, 
      std::ref(tm), transferAmount);
00171     \}
00172     \textcolor{comment}{/* @173-175 Join all the threads created */}
00173     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < threadArraySize; ++i) \{
00174         thArray[i].join();
00175     \}
00176 
00177     \textcolor{comment}{/* @178-179 Display objects after all transactions are finished */}
00178     aib\_ptr->toString();
00179     boi\_ptr->toString();
00180 
00181     \textcolor{comment}{/* @182 For testing purpose create a new transaction object to print out the rollback counter */}
00182     std::shared\_ptr<TX> tx = tm.\hyperlink{class_t_m_a41cb0226cc4080c931651b13f74a0075_a41cb0226cc4080c931651b13f74a0075}{\_get\_tx}();
00183 
00184     \textcolor{comment}{/* @185 Display the rollback number from the transaction class*/}
00185     std::cout << \textcolor{stringliteral}{"Rollback counter is : "} << tx->getTest\_counter() << std::endl;
00186 
00187     \textcolor{comment}{/* @188 Clean up Transaction Manager from all main process associated transactions */}
00188     tm.\hyperlink{class_t_m_a5e2d1127f2429f2f524d25f430eade06_a5e2d1127f2429f2f524d25f430eade06}{\_TX\_EXIT}();
00189     \textcolor{comment}{/* @190 Display all Transactions associated with the main process. It should be empty after \_TX\_EXIT()
       function call!!! */}
00190     tm.\hyperlink{class_t_m_a1d6891b1d3e71cc0acef54e7afe71c09_a1d6891b1d3e71cc0acef54e7afe71c09}{print\_all}();
00191 
00192     \textcolor{keywordflow}{return} 0;
00193 \}
\end{DoxyCode}
