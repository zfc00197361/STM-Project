\hypertarget{_t_x_8cpp_source}{}\subsection{T\+X.\+cpp}

\begin{DoxyCode}
00001 \textcolor{comment}{/* }
00002 \textcolor{comment}{ * File:   TX.cpp}
00003 \textcolor{comment}{ * Author: Zoltan Fuzesi}
00004 \textcolor{comment}{ * }
00005 \textcolor{comment}{ * Created on December 18, 2017, 2:09 PM}
00006 \textcolor{comment}{ * TX cpp file methods implementations}
00007 \textcolor{comment}{ */}
00008 \textcolor{preprocessor}{#include "\hyperlink{_t_x_8h}{TX.h}"}
00009 \textcolor{preprocessor}{#include <iostream>}
00013 std::map<int, std::shared\_ptr<OSTM> >TX::main\_Process\_Map\_collection;
00017 std::map<int, std::map< int, int >> TX::process\_map\_collection;
00021 std::mutex TX::register\_Lock;
00025 \textcolor{keywordtype}{int} TX::test\_counter = 0;
00031 TX::TX(std::thread::id \textcolor{keywordtype}{id}) \{
00032     this->transaction\_Number = id;
00033     this->\_tx\_nesting\_level = 0;
00034 \}
00038 TX::~TX() \{
00039    
00040 \}
00044 TX::TX(\textcolor{keyword}{const} TX& orig) \{
00045 
00046 \}
00047 
00052 \textcolor{keywordtype}{void} TX::th\_exit() \{
00053 
00054     \textcolor{keywordflow}{if} (this->\_tx\_nesting\_level > 0) \{
00055         \textcolor{comment}{/*}
00056 \textcolor{comment}{         * Active nested transactions running in background, do not delete anything yet}
00057 \textcolor{comment}{         */}
00058     \} \textcolor{keywordflow}{else} \{
00059         \textcolor{comment}{/* }
00060 \textcolor{comment}{         * Remove all elements map entries from transaction and clear the map}
00061 \textcolor{comment}{         */}
00062         working\_Map\_collection.clear();
00063     \}
00064 \}
00065 
00072 \textcolor{keywordtype}{void} TX::ostm\_exit() \{
00073     std::map<int, std::shared\_ptr<OSTM>>::iterator main\_Process\_Map\_collection\_Iterator;
00074      
00075     \textcolor{keywordtype}{int} ppid = \_getpid();
00076     std::map<int, std::map< int, int >>::iterator process\_map\_collection\_Iterator = 
      TX::process\_map\_collection.find(ppid);
00077     \textcolor{keywordflow}{if} (process\_map\_collection\_Iterator != TX::process\_map\_collection.end()) \{
00078 
00079         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} current = process\_map\_collection\_Iterator->second.begin(); current != 
      process\_map\_collection\_Iterator->second.end(); ++current) \{
00080             main\_Process\_Map\_collection\_Iterator = TX::main\_Process\_Map\_collection.find(current->first);
00081 
00082             \textcolor{keywordflow}{if} (main\_Process\_Map\_collection\_Iterator != TX::main\_Process\_Map\_collection.end())\{
00083                 \textcolor{comment}{/*}
00084 \textcolor{comment}{                 * Delete element from shared main\_Process\_Map\_collection by object unique key value,
       shared\_ptr will destroy automatically}
00085 \textcolor{comment}{                 */}
00086                 TX::main\_Process\_Map\_collection.erase(main\_Process\_Map\_collection\_Iterator->first);      
00087             \}
00088         \}
00089         \textcolor{comment}{/*}
00090 \textcolor{comment}{         * Delete from Process\_map\_collection, Main process exits delete association with library}
00091 \textcolor{comment}{         */}
00092         TX::process\_map\_collection.erase(process\_map\_collection\_Iterator->first);
00093     \}
00094 \}
00095 
00104 \textcolor{keywordtype}{void} TX::\_register(std::shared\_ptr<OSTM> \textcolor{keywordtype}{object}) \{
00105     \textcolor{comment}{/*}
00106 \textcolor{comment}{     * MUST USE SHARED LOCK TO PROTECT SHARED GLOBAL MAP/COLLECTION }
00107 \textcolor{comment}{     */}
00108     std::lock\_guard<std::mutex> guard(TX::register\_Lock);
00109     
00110     \textcolor{comment}{/*}
00111 \textcolor{comment}{     * Check for null pointer !}
00112 \textcolor{comment}{     * Null pointer can cause segmentation fault!!!}
00113 \textcolor{comment}{     */}
00114     \textcolor{keywordflow}{if}(\textcolor{keywordtype}{object} == \textcolor{keyword}{nullptr})\{
00115         \textcolor{keywordflow}{throw} std::runtime\_error(std::string(\textcolor{stringliteral}{"[RUNTIME ERROR : NULL POINTER IN REGISTER FUNCTION]"}) );
00116     \}
00117     
00118     \textcolor{keywordtype}{int} ppid = \_getpid();
00119     std::map<int, std::map< int, int >>::iterator process\_map\_collection\_Iterator = 
      TX::process\_map\_collection.find(ppid);
00120     \textcolor{keywordflow}{if} (process\_map\_collection\_Iterator == TX::process\_map\_collection.end()) \{
00121         \textcolor{comment}{/*}
00122 \textcolor{comment}{         * Register main process/application to the global map}
00123 \textcolor{comment}{         */}
00124         std::map< int, int >map =  get\_thread\_Map();
00125         TX::process\_map\_collection.insert(\{ppid, map\});
00126         \textcolor{comment}{/*}
00127 \textcolor{comment}{         * Get the map if registered first time}
00128 \textcolor{comment}{         */}
00129         process\_map\_collection\_Iterator = TX::process\_map\_collection.find(ppid);
00130     \}
00131     std::map<int, std::shared\_ptr<OSTM>>::iterator main\_Process\_Map\_collection\_Iterator = 
      TX::main\_Process\_Map\_collection.find(object->Get\_Unique\_ID());
00132     \textcolor{keywordflow}{if} (main\_Process\_Map\_collection\_Iterator == TX::main\_Process\_Map\_collection.end()) \{
00133         \textcolor{comment}{/*}
00134 \textcolor{comment}{         * Insert to the GLOBAL MAP }
00135 \textcolor{comment}{         */}
00136         TX::main\_Process\_Map\_collection.insert(\{\textcolor{keywordtype}{object}->Get\_Unique\_ID(), \textcolor{keywordtype}{object}\});
00137         \textcolor{comment}{/*}
00138 \textcolor{comment}{         * Insert to the GLOBAL MAP as a helper to clean up at end of main process }
00139 \textcolor{comment}{         */}
00140         process\_map\_collection\_Iterator->second.insert(\{\textcolor{keywordtype}{object}->Get\_Unique\_ID(), 1\});
00141     \} 
00142 
00143 
00144     std::map< int, std::shared\_ptr<OSTM> >::iterator working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator 
      = working\_Map\_collection.find(object->Get\_Unique\_ID());
00145     \textcolor{keywordflow}{if} (working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator == working\_Map\_collection.end()) \{
00146 
00147         working\_Map\_collection.insert(\{\textcolor{keywordtype}{object}->Get\_Unique\_ID(), \textcolor{keywordtype}{object}->getBaseCopy(\textcolor{keywordtype}{object})\});
00148     \}
00149 
00150 \}
00155 std::shared\_ptr<OSTM> TX::load(std::shared\_ptr<OSTM> \textcolor{keywordtype}{object}) \{
00156 
00157     std::map< int, std::shared\_ptr<OSTM> >::iterator working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator;
00158     \textcolor{comment}{/*}
00159 \textcolor{comment}{     * Check for null pointer !}
00160 \textcolor{comment}{     * Null pointer can cause segmentation fault!!!}
00161 \textcolor{comment}{     */}
00162     \textcolor{keywordflow}{if}(\textcolor{keywordtype}{object} == \textcolor{keyword}{nullptr})\{
00163         \textcolor{keywordflow}{throw} std::runtime\_error(std::string(\textcolor{stringliteral}{"[RUNTIME ERROR : NULL POINTER IN LOAD FUNCTION]"}) );
00164     \}
00165 
00166         working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator = working\_Map\_collection.find(object->
      Get\_Unique\_ID());
00167 
00168     \textcolor{keywordflow}{if} (working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator != working\_Map\_collection.end()) \{
00169 
00170         \textcolor{keywordflow}{return} working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second->getBaseCopy(
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second);
00171         
00172     \} \textcolor{keywordflow}{else} \{ \textcolor{keywordflow}{throw} std::runtime\_error(std::string(\textcolor{stringliteral}{"[RUNTIME ERROR : NO OBJECT FOUND LOAD FUNCTION]"}) );\}
00173 \}
00178 \textcolor{keywordtype}{void} TX::store(std::shared\_ptr<OSTM> \textcolor{keywordtype}{object}) \{
00179     \textcolor{comment}{/*}
00180 \textcolor{comment}{     * Check for null pointer !}
00181 \textcolor{comment}{     * Null pointer can cause segmentation fault!!!}
00182 \textcolor{comment}{     */}
00183     \textcolor{keywordflow}{if}(\textcolor{keywordtype}{object} == \textcolor{keyword}{nullptr})\{
00184         \textcolor{keywordflow}{throw} std::runtime\_error(std::string(\textcolor{stringliteral}{"[RUNTIME ERROR : NULL POINTER IN STORE FUNCTION]"}) );
00185     \}
00186     
00187     std::map< int, std::shared\_ptr<OSTM> >::iterator working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator;
00188 
00189     working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator = working\_Map\_collection.find(object->
      Get\_Unique\_ID());
00190     \textcolor{keywordflow}{if} (working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator != working\_Map\_collection.end()) \{
00191 
00192         working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second = object;
00193 
00194     \} \textcolor{keywordflow}{else} \{ std::cout << \textcolor{stringliteral}{"[ERROR STORE]"} << std::endl; \}
00195 \}
00202 \textcolor{keywordtype}{bool} TX::commit() \{
00203 
00204     \textcolor{keywordtype}{bool} can\_Commit = \textcolor{keyword}{true};
00205  
00206     \textcolor{comment}{/*}
00207 \textcolor{comment}{     * Dealing with nested transactions first }
00208 \textcolor{comment}{     */}
00209     \textcolor{keywordflow}{if} (this->\_tx\_nesting\_level > 0) \{
00210         \_decrease\_tx\_nesting();
00211         \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00212     \} 
00213     
00214     std::map< int, std::shared\_ptr<OSTM> >::iterator working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator;
00215 
00216     std::map<int, std::shared\_ptr<OSTM>>::iterator main\_Process\_Map\_collection\_Iterator;
00217     \textcolor{keywordflow}{for} (working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator = working\_Map\_collection.begin(); 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator != working\_Map\_collection.end(); 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator++) \{
00218 
00219             main\_Process\_Map\_collection\_Iterator = TX::main\_Process\_Map\_collection.find(
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second->Get\_Unique\_ID());
00220             \textcolor{comment}{/*}
00221 \textcolor{comment}{             * Throws runtime error if object can not find}
00222 \textcolor{comment}{             */}
00223             \textcolor{keywordflow}{if}(main\_Process\_Map\_collection\_Iterator == TX::main\_Process\_Map\_collection.end())
00224             \{
00225                 \textcolor{keywordflow}{throw} std::runtime\_error(std::string(\textcolor{stringliteral}{"[RUNTIME ERROR : CAN'T FIND OBJECT COMMIT FUNCTION]"})
      );
00226             \}
00227 
00228         \textcolor{comment}{/*}
00229 \textcolor{comment}{         * Busy wait WHILE object locked by other thread}
00230 \textcolor{comment}{         */}
00231         \textcolor{keywordflow}{while}(!(main\_Process\_Map\_collection\_Iterator->second)->is\_Locked());
00232 
00233         \textcolor{keywordflow}{if} (main\_Process\_Map\_collection\_Iterator->second->Get\_Version() > 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second->Get\_Version()) \{
00234 
00235             working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second->Set\_Can\_Commit(\textcolor{keyword}{false});
00236             can\_Commit = \textcolor{keyword}{false};
00237             \textcolor{keywordflow}{break};
00238         \} \textcolor{keywordflow}{else} \{
00239 
00240             working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second->Set\_Can\_Commit(\textcolor{keyword}{true});
00241         \}
00242     \}
00243     \textcolor{keywordflow}{if} (!can\_Commit) \{
00244         TX::test\_counter += 1;
00245         \textcolor{keywordflow}{for} (working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator = working\_Map\_collection.begin(); 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator != working\_Map\_collection.end(); 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator++) \{
00246           
00247             main\_Process\_Map\_collection\_Iterator  = TX::main\_Process\_Map\_collection.find(
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second->Get\_Unique\_ID());
00248             (working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second)->copy(
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second, main\_Process\_Map\_collection\_Iterator->second);
00249 
00250         \}
00251         
00252         \_release\_object\_lock();
00253 
00254         \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00255     \} \textcolor{keywordflow}{else} \{
00256         \textcolor{comment}{/*}
00257 \textcolor{comment}{         * Commit changes}
00258 \textcolor{comment}{         */}
00259         \textcolor{keywordflow}{for} (working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator = working\_Map\_collection.begin(); 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator != working\_Map\_collection.end(); 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator++) \{
00260             
00261                 main\_Process\_Map\_collection\_Iterator = TX::main\_Process\_Map\_collection.find((
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second)->Get\_Unique\_ID());
00262                 \textcolor{keywordflow}{if} (main\_Process\_Map\_collection\_Iterator != TX::main\_Process\_Map\_collection.end()) \{
00263 
00264                     (main\_Process\_Map\_collection\_Iterator->second)->copy(
      main\_Process\_Map\_collection\_Iterator->second, working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second);
00265                     main\_Process\_Map\_collection\_Iterator->second->increase\_VersionNumber();
00266 
00267 
00268                 \} \textcolor{keywordflow}{else} \{
00269                     \textcolor{keywordflow}{throw} std::runtime\_error(std::string(\textcolor{stringliteral}{"[RUNTIME ERROR : CAN'T FIND OBJECT COMMIT
       FUNCTION]"}));
00270 
00271                 \}
00272         \}
00273 
00274 
00275         \_release\_object\_lock();
00276         this->th\_exit();
00277         \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00278     \}
00279 \}\textcolor{comment}{//Commit finish}
00280 
00286 \textcolor{keywordtype}{void} TX::\_release\_object\_lock()\{
00287     
00288     std::map< int, std::shared\_ptr<OSTM> >::iterator working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator;
00289     std::map<int, std::shared\_ptr<OSTM>>::iterator main\_Process\_Map\_collection\_Iterator;
00290     \textcolor{keywordflow}{for} (working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator = working\_Map\_collection.begin(); 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator != working\_Map\_collection.end(); 
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator++) \{
00291 
00292             main\_Process\_Map\_collection\_Iterator = TX::main\_Process\_Map\_collection.find((
      working\_Map\_collection\_Object\_Shared\_Pointer\_Iterator->second)->Get\_Unique\_ID());
00293             \textcolor{keywordflow}{if} (main\_Process\_Map\_collection\_Iterator != TX::main\_Process\_Map\_collection.end()) \{
00294                 \textcolor{comment}{/*}
00295 \textcolor{comment}{                 * Release object lock}
00296 \textcolor{comment}{                 */}
00297                 (main\_Process\_Map\_collection\_Iterator)->second->unlock\_Mutex();
00298                 
00299             \} 
00300         \}
00301 \}
00302 
00307 \textcolor{keywordtype}{void} TX::\_increase\_tx\_nesting() \{
00308       
00309     this->\_tx\_nesting\_level += 1;
00310     \textcolor{comment}{// std::cout << "[this->\_tx\_nesting\_level] = " << this->\_tx\_nesting\_level << std::endl;}
00311 \}
00316 \textcolor{keywordtype}{void} TX::\_decrease\_tx\_nesting() \{
00317    \textcolor{comment}{// std::cout << "[this->\_tx\_nesting\_level] = " << this->\_tx\_nesting\_level << std::endl;}
00318     this->\_tx\_nesting\_level -= 1;
00319 ;
00320 \}
00324 \textcolor{keywordtype}{int} TX::getTest\_counter() \{
00325     \textcolor{keywordflow}{return} TX::test\_counter;
00326 \}
00331 \textcolor{keyword}{const} std::thread::id TX::\_get\_tx\_number()\textcolor{keyword}{ const }\{
00332     \textcolor{keywordflow}{return} transaction\_Number;
00333 \}
00338 std::map< int, int > TX::get\_thread\_Map() \{
00339     std::map< int, int > thread\_Map;
00340     \textcolor{keywordflow}{return} thread\_Map;
00341 \}
00342 
00346 \textcolor{keywordtype}{void} TX::\_print\_all\_tx() \{
00347 
00348     std::cout << \textcolor{stringliteral}{"[PRINTALLTHREAD]"} << std::endl;
00349     std::map< int, std::shared\_ptr<OSTM> >::iterator it;
00350     \textcolor{comment}{/*}
00351 \textcolor{comment}{     * All registered thread id in the TX global }
00352 \textcolor{comment}{     */}
00353      \textcolor{keywordtype}{int} ppid = \_getpid();
00354     std::map<int, std::map< int, int >>::iterator process\_map\_collection\_Iterator = 
      TX::process\_map\_collection.find(ppid);
00355     \textcolor{keywordflow}{if} (process\_map\_collection\_Iterator != TX::process\_map\_collection.end()) \{
00356 
00357         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} current = process\_map\_collection\_Iterator->second.begin(); current != 
      process\_map\_collection\_Iterator->second.end(); ++current) \{
00358             it = working\_Map\_collection.find(current->first);
00359             \textcolor{keywordflow}{if}(it != working\_Map\_collection.end())\{
00360                 std::cout << \textcolor{stringliteral}{"[Unique number ] : "} <<it->second->Get\_Unique\_ID() << std::endl;
00361             \}
00362 
00363             
00364         \}
00365      
00366     \}
00367 \}
\end{DoxyCode}
